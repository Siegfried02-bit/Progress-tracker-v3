<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Tracker</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header-nav">
        <button data-view="goals-view" class="active">Objectifs</button>
        <button data-view="notes-view">Notes</button>
    </div>

    <div id="goals-view" class="view" style="display: block;">
        <h1>Progress Tracker</h1>

        <div class="main-content-flex">
            <div class="left-panel">
                <div class="add-goal-section">
                    <h2>Ajouter un nouvel objectif :</h2>
                    <label for="goal-name">Nom de l'objectif :</label>
                    <input type="text" id="goal-name" placeholder="ex: Lire un livre">

                    <label for="goal-type">Type d'objectif :</label>
                    <select id="goal-type" onchange="toggleGoalTypeOptions()">
                        <option value="numeric">Numérique (ex: lire X pages)</option>
                        <option value="todo">À faire (ex: terminer une tâche)</option>
                        <option value="recurrent">Récurrent (ex: sport quotidien)</option>
                    </select>

                    <div id="numeric-options" style="display: block;">
                        <label for="goal-target">Cible :</label>
                        <input type="number" id="goal-target" min="1" placeholder="ex: 50">
                        <label for="goal-unit">Unité (optionnel) :</label>
                        <input type="text" id="goal-unit" placeholder="ex: pages">
                    </div>
                    <div id="recurrent-options" style="display: none;">
                        <label for="recurrence-frequency">Fréquence :</label>
                        <select id="recurrence-frequency">
                            <option value="daily">Quotidien</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuel</option>
                        </select>
                    </div>

                    <label for="goal-category">Catégorie :</label>
                    <select id="goal-category">
                        <option value="Aucune">Aucune</option>
                    </select>
                    <button onclick="showCustomCategoryInput()">Ajouter une catégorie personnalisée</button>
                    <div id="custom-category-input" style="display: none;">
                        <input type="text" id="new-category-name" placeholder="Nom de la catégorie">
                        <button onclick="addCustomCategory()">Ajouter</button>
                    </div>

                    <label for="goal-due-date">Date d'échéance (optionnel) :</label>
                    <input type="date" id="goal-due-date">

                    <label for="goal-reminder">Rappel (optionnel) :</label>
                    <input type="datetime-local" id="goal-reminder">

                    <button onclick="addGoal()">Ajouter un objectif</button>
                </div>

                <div class="statistics-section">
                    <h2>Statistiques des objectifs :</h2>
                    <p>Total d'objectifs : <span id="total-goals">0</span></p>
                    <p>Objectifs complétés : <span id="completed-goals">0</span></p>
                    <p>Objectifs en attente : <span id="pending-goals">0</span></p>
                    <h3>Objectifs par catégorie :</h3>
                    <ul id="category-stats"></ul>
                </div>
            </div>

            <div class="right-panel">
                <div id="active-goals">
                    <h2>Objectifs actifs</h2>
                    <div id="goal-list"></div>
                </div>
                <div id="completed-goals" class="view">
                    <h2>Objectifs complétés</h2>
                    <div id="completed-goal-list"></div>
                </div>
            </div>
        </div>

        <div class="manage-category-toggle-section">
            <h2 onclick="toggleCategoryManagement()">Gérer les catégories <span class="arrow-down"></span></h2>
            <div id="category-management" style="display: none;">
                <div id="category-list"></div>
            </div>
        </div>

        <div class="filter-sort-section">
            <h2>Filtrer & trier les objectifs :</h2>
            <label>Filtrer par catégorie :</label>
            <div id="filter-category-checkboxes" class="category-checkboxes"></div>
            <label for="sort-goals">Trier par :</label>
            <select id="sort-goals" onchange="renderGoals()">
                <option value="name">Nom</option>
                <option value="progress-asc">Progression (Croissant)</option>
                <option value="progress-desc">Progression (Décroissant)</option>
                <option value="created">Date de création</option>
                <option value="due-date">Date d'échéance</option>
            </select>
            <label for="search-goals">Rechercher :</label>
            <input type="text" id="search-goals" onkeyup="renderGoals()" placeholder="Rechercher un objectif...">
        </div>

        <div class="daily-log-section">
            <h2>Consultation du temps passé par jour :</h2>
            <label for="log-date">Sélectionnez une date :</label>
            <input type="date" id="log-date" onchange="showDailyLog()">
            <div id="daily-log-details" class="daily-log-details" style="display: none;">
                <h3>Détails pour la date sélectionnée :</h3>
                <p>Temps total passé : <span id="daily-total-time">00:00:00</span></p>
                <h4>Détail par objectif :</h4>
                <ul id="daily-goal-details"></ul>
            </div>
        </div>

        <div class="utility-buttons">
            <button onclick="toggleDarkMode()">Mode Sombre</button>
            <button onclick="exportGoals()">Exporter les objectifs</button>
            <input type="file" id="import-file" onchange="importGoals(event)" style="display: none;">
            <button onclick="document.getElementById('import-file').click()">Importer des objectifs</button>
        </div>
    </div>

    <div id="notes-view" class="view">
        <h1>Mes Notes</h1>
        <div class="add-note-section">
            <h2>Ajouter une nouvelle note :</h2>
            <label for="note-title">Titre de la note :</label>
            <input type="text" id="note-title" placeholder="ex: Idée rapide">
            <label for="note-content">Contenu de la note :</label>
            <textarea id="note-content" placeholder="Écrivez votre note ici..."></textarea>
            <label for="note-category">Catégorie de la note :</label>
            <select id="note-category">
                <option value="Aucune">Aucune</option>
            </select>
            <button onclick="addNote()">Ajouter la note</button>
        </div>

        <div class="filter-sort-section">
            <h2>Filtrer & trier les notes :</h2>
            <label for="note-filter-category">Filtrer par catégorie :</label>
            <select id="note-filter-category" onchange="renderNotes()">
                <option value="Toutes">Toutes</option>
            </select>
            <label for="search-notes">Rechercher :</label>
            <input type="text" id="search-notes" onkeyup="renderNotes()" placeholder="Rechercher une note...">
        </div>

        <div id="note-list"></div>
    </div>

    <div id="toast" class="toast-notification"></div>
    <div id="undo-notification" class="undo-notification">
        <span>Action annulée !</span>
        <button onclick="undoAction()">Confirmer</button>
    </div>

    <script>
        let goals = [];
        let categories = ["Aucune"];
        let notes = [];
        let deletedItem = null;

        function toggleView(event) {
            const viewId = event.target.dataset.view;
            document.querySelectorAll('.view').forEach(view => view.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.header-nav button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        document.querySelectorAll('.header-nav button').forEach(button => {
            button.addEventListener('click', toggleView);
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        function toggleGoalTypeOptions() {
            const goalType = document.getElementById('goal-type').value;
            document.getElementById('numeric-options').style.display = goalType === 'numeric' ? 'block' : 'none';
            document.getElementById('recurrent-options').style.display = goalType === 'recurrent' ? 'block' : 'none';
        }

        function showCustomCategoryInput() {
            document.getElementById('custom-category-input').style.display = 'block';
        }

        function addCustomCategory() {
            const newCategory = document.getElementById('new-category-name').value.trim();
            if (newCategory && !categories.includes(newCategory)) {
                categories.push(newCategory);
                updateCategoryOptions();
                document.getElementById('new-category-name').value = '';
                document.getElementById('custom-category-input').style.display = 'none';
                renderCategoryManagement();
            }
        }

        function updateCategoryOptions() {
            const goalSelect = document.getElementById('goal-category');
            const noteSelect = document.getElementById('note-category');
            const filterSelect = document.getElementById('note-filter-category');
            [goalSelect, noteSelect].forEach(select => {
                select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            });
            filterSelect.innerHTML = '<option value="Toutes">Toutes</option>' + categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            renderFilterCheckboxes();
        }

        function addGoal() {
            const name = document.getElementById('goal-name').value.trim();
            const type = document.getElementById('goal-type').value;
            const category = document.getElementById('goal-category').value;
            const dueDate = document.getElementById('goal-due-date').value;
            const reminder = document.getElementById('goal-reminder').value;

            if (!name) {
                showToast('Veuillez entrer un nom pour l\'objectif.', 'error');
                return;
            }

            const goal = {
                id: Date.now(),
                name,
                type,
                category,
                created: new Date().toLocaleString(),
                dueDate: dueDate || null,
                completed: false,
                progress: 0,
                progressHistory: []
            };

            if (type === 'numeric') {
                goal.target = parseInt(document.getElementById('goal-target').value) || 1;
                goal.unit = document.getElementById('goal-unit').value.trim() || '';
            } else if (type === 'recurrent') {
                goal.recurrence = document.getElementById('recurrence-frequency').value;
                goal.completionLog = [];
            }

            if (reminder) {
                scheduleNotification(goal.id, reminder);
            }

            goals.push(goal);
            resetGoalForm();
            renderGoals();
            updateStats();
            showToast('Objectif ajouté avec succès !', 'success');
        }

        function resetGoalForm() {
            document.getElementById('goal-name').value = '';
            document.getElementById('goal-type').value = 'numeric';
            document.getElementById('goal-target').value = '';
            document.getElementById('goal-unit').value = '';
            document.getElementById('goal-due-date').value = '';
            document.getElementById('goal-reminder').value = '';
            toggleGoalTypeOptions();
        }

        function renderGoals() {
            const goalList = document.getElementById('goal-list');
            const completedList = document.getElementById('completed-goal-list');
            const search = document.getElementById('search-goals').value.toLowerCase();
            const sortBy = document.getElementById('sort-goals').value;
            const filters = Array.from(document.querySelectorAll('#filter-category-checkboxes input:checked')).map(cb => cb.value);

            let filteredGoals = goals.filter(goal => 
                goal.name.toLowerCase().includes(search) &&
                (filters.length === 0 || filters.includes(goal.category))
            );

            filteredGoals.sort((a, b) => {
                if (sortBy === 'name') return a.name.localeCompare(b.name);
                if (sortBy === 'progress-asc') return a.progress - b.progress;
                if (sortBy === 'progress-desc') return b.progress - a.progress;
                if (sortBy === 'created') return new Date(a.created) - new Date(b.created);
                if (sortBy === 'due-date') return (a.dueDate || '9999-12-31') > (b.dueDate || '9999-12-31') ? 1 : -1;
            });

            goalList.innerHTML = '';
            completedList.innerHTML = '';

            filteredGoals.forEach(goal => {
                const container = goal.completed ? completedList : goalList;
                const progressPercent = goal.type === 'numeric' ? (goal.progress / goal.target * 100).toFixed(2) : goal.type === 'todo' && goal.progress === 1 ? 100 : 0;
                const isCompleted = goal.completed || (goal.type === 'numeric' && goal.progress >= goal.target) || (goal.type === 'todo' && goal.progress === 1);

                if (isCompleted && !goal.completed) {
                    goal.completed = true;
                    triggerCelebration(goal.id);
                }

                const goalHtml = `
                    <div class="goal ${isCompleted ? 'completed-goal' : ''}" id="goal-${goal.id}">
                        <h3>${goal.name}</h3>
                        <p>Catégorie : ${goal.category}</p>
                        ${goal.dueDate ? `<p class="due-date ${isOverdue(goal.dueDate) ? 'overdue' : ''}">Échéance : ${formatDate(goal.dueDate)}</p>` : ''}
                        ${goal.type === 'numeric' ? `
                            <p>Progrès : ${goal.progress} / ${goal.target} ${goal.unit}</p>
                            <div class="progress-bar ${isCompleted ? 'completed-bar' : ''}">
                                <div class="progress" style="width: ${progressPercent}%"></div>
                            </div>
                            <input type="number" id="progress-input-${goal.id}" min="0" placeholder="Ajouter progrès">
                            <button onclick="addProgress(${goal.id})">Ajouter</button>
                            <div class="history-display">
                                <h4>Historique des progrès</h4>
                                <ul>${goal.progressHistory.map(h => `<li>${h.date} : ${h.amount} ${goal.unit}</li>`).join('')}</ul>
                            </div>
                            <canvas id="progressChart-${goal.id}" width="400" height="200"></canvas>
                        ` : goal.type === 'recurrent' ? `
                            <p>Récurrence : ${goal.recurrence}</p>
                            <ul>${goal.completionLog.map(log => `<li>${log.date} : ${log.completed ? 'Fait' : 'Non Fait'}</li>`).slice(-5).join('')}</ul>
                            <button onclick="toggleRecurrentGoal(${goal.id})">Marquer comme ${goal.completionLog.some(l => l.date === today() && l.completed) ? 'Non Fait' : 'Fait'}</button>
                        ` : `
                            <p>Statut : ${goal.progress === 1 ? 'Complété' : 'En cours'}</p>
                            <button onclick="toggleTodoGoal(${goal.id})">${goal.progress === 1 ? 'Marquer comme incomplet' : 'Marquer comme complet'}</button>
                        `}
                        <button class="delete-goal-btn" onclick="deleteGoal(${goal.id})">×</button>
                    </div>
                `;
                container.innerHTML += goalHtml;

                if (goal.type === 'numeric' && goal.progressHistory.length > 0) {
                    renderProgressChart(goal);
                }
            });

            if (goalList.children.length === 0) goalList.innerHTML = '<p class="no-goals-message">Aucun objectif actif trouvé.</p>';
            if (completedList.children.length === 0) completedList.innerHTML = '<p class="no-goals-message">Aucun objectif complété trouvé.</p>';
        }

        function addProgress(goalId) {
            const goal = goals.find(g => g.id === goalId);
            const amount = parseInt(document.getElementById(`progress-input-${goalId}`).value);
            if (amount && amount > 0) {
                goal.progress += amount;
                goal.progressHistory.push({ date: new Date().toLocaleString(), amount });
                if (goal.progress >= goal.target) {
                    goal.completed = true;
                    triggerCelebration(goalId);
                }
                renderGoals();
                updateStats();
            }
        }

        function renderProgressChart(goal) {
            const ctx = document.getElementById(`progressChart-${goal.id}`).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: goal.progressHistory.map(h => h.date),
                    datasets: [{
                        label: 'Progrès',
                        data: goal.progressHistory.map(h => h.amount),
                        borderColor: '#28a745',
                        fill: false
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function toggleRecurrentGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            const todayStr = today();
            const todayLog = goal.completionLog.find(l => l.date === todayStr);
            if (todayLog) {
                todayLog.completed = !todayLog.completed;
            } else {
                goal.completionLog.push({ date: todayStr, completed: true });
            }
            renderGoals();
        }

        function today() {
            return new Date().toISOString().split('T')[0];
        }

        function toggleTodoGoal(goalId) {
            const goal = goals.find(g => g.id === goalId);
            goal.progress = goal.progress === 1 ? 0 : 1;
            goal.completed = goal.progress === 1;
            if (goal.completed) triggerCelebration(goalId);
            renderGoals();
            updateStats();
        }

        function triggerCelebration(goalId) {
            const goalElement = document.getElementById(`goal-${goalId}`);
            goalElement.classList.add('confetti-animation');
            setTimeout(() => goalElement.classList.remove('confetti-animation'), 1500);
            showToast('Félicitations ! Objectif atteint !', 'success');
        }

        function deleteGoal(goalId) {
            const goalIndex = goals.findIndex(g => g.id === goalId);
            deletedItem = goals.splice(goalIndex, 1)[0];
            showUndoNotification('Objectif supprimé.');
            renderGoals();
            updateStats();
        }

        function updateStats() {
            document.getElementById('total-goals').textContent = goals.length;
            document.getElementById('completed-goals').textContent = goals.filter(g => g.completed).length;
            document.getElementById('pending-goals').textContent = goals.filter(g => !g.completed).length;

            const categoryStats = {};
            goals.forEach(g => categoryStats[g.category] = (categoryStats[g.category] || 0) + 1);
            document.getElementById('category-stats').innerHTML = Object.entries(categoryStats)
                .map(([cat, count]) => `<li>${cat} : ${count}</li>`).join('');
        }

        function toggleCategoryManagement() {
            const section = document.getElementById('category-management');
            const arrow = document.querySelector('.manage-category-toggle-section h2 .arrow-down, .manage-category-toggle-section h2 .arrow-up');
            section.style.display = section.style.display === 'none' ? 'block' : 'none';
            arrow.classList.toggle('arrow-down');
            arrow.classList.toggle('arrow-up');
            renderCategoryManagement();
        }

        function renderCategoryManagement() {
            const list = document.getElementById('category-list');
            list.innerHTML = categories.filter(c => c !== 'Aucune').map(cat => `
                <div class="category-list-item">
                    <span>${cat}</span>
                    <div>
                        <button onclick="editCategory('${cat}')">Éditer</button>
                        <button class="delete-category-btn" onclick="deleteCategory('${cat}')">Supprimer</button>
                    </div>
                </div>
            `).join('');
        }

        function editCategory(oldName) {
            const newName = prompt('Nouveau nom pour la catégorie :', oldName);
            if (newName && newName !== oldName && !categories.includes(newName)) {
                categories[categories.indexOf(oldName)] = newName;
                goals.forEach(g => { if (g.category === oldName) g.category = newName; });
                updateCategoryOptions();
                renderCategoryManagement();
                renderGoals();
            }
        }

        function deleteCategory(name) {
            if (confirm(`Supprimer la catégorie "${name}" ? Les objectifs associés seront déplacés vers "Aucune".`)) {
                categories = categories.filter(c => c !== name);
                goals.forEach(g => { if (g.category === name) g.category = 'Aucune'; });
                updateCategoryOptions();
                renderCategoryManagement();
                renderGoals();
            }
        }

        function renderFilterCheckboxes() {
            const container = document.getElementById('filter-category-checkboxes');
            container.innerHTML = categories.map(cat => `
                <label><input type="checkbox" value="${cat}" onchange="renderGoals()"> ${cat}</label>
            `).join('');
        }

        function showDailyLog() {
            const date = document.getElementById('log-date').value;
            document.getElementById('daily-log-details').style.display = 'block';
            // Logique simplifiée ici (pas de chronomètre dans cet exemple)
        }

        function exportGoals() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ goals, categories }));
            const a = document.createElement('a');
            a.setAttribute('href', dataStr);
            a.setAttribute('download', 'progress_tracker.json');
            a.click();
        }

        function importGoals(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = JSON.parse(e.target.result);
                goals = data.goals || [];
                categories = data.categories || ['Aucune'];
                updateCategoryOptions();
                renderGoals();
                updateStats();
            };
            reader.readAsText(file);
        }

        function scheduleNotification(goalId, reminderTime) {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.pushManager.subscribe({ userVisibleOnly: true }).then(() => {
                        setTimeout(() => {
                            registration.showNotification('Rappel Progress Tracker', {
                                body: `N'oubliez pas votre objectif !`,
                                icon: 'icon-192.png'
                            });
                        }, new Date(reminderTime) - Date.now());
                    });
                });
            }
        }

        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast-notification ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showUndoNotification(message) {
            const undo = document.getElementById('undo-notification');
            undo.children[0].textContent = message;
            undo.classList.add('show');
            setTimeout(() => undo.classList.remove('show'), 5000);
        }

        function undoAction() {
            if (deletedItem) {
                goals.push(deletedItem);
                deletedItem = null;
                renderGoals();
                updateStats();
                document.getElementById('undo-notification').classList.remove('show');
            }
        }

        function isOverdue(dueDate) {
            return new Date(dueDate) < new Date() && !goal.completed;
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('fr-FR');
        }

        function addNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            const category = document.getElementById('note-category').value;
            if (title && content) {
                notes.push({ id: Date.now(), title, content, category });
                document.getElementById('note-title').value = '';
                document.getElementById('note-content').value = '';
                renderNotes();
                showToast('Note ajoutée avec succès !', 'success');
            }
        }

        function renderNotes() {
            const noteList = document.getElementById('note-list');
            const search = document.getElementById('search-notes').value.toLowerCase();
            const filterCategory = document.getElementById('note-filter-category').value;

            const filteredNotes = notes.filter(note =>
                (note.title.toLowerCase().includes(search) || note.content.toLowerCase().includes(search)) &&
                (filterCategory === 'Toutes' || note.category === filterCategory)
            );

            noteList.innerHTML = filteredNotes.map(note => `
                <div class="goal">
                    <h3>${note.title}</h3>
                    <p>${note.content}</p>
                    <p>Catégorie : ${note.category}</p>
                    <button class="delete-note-btn" onclick="deleteNote(${note.id})">×</button>
                </div>
            `).join('') || '<p class="no-notes-message">Aucune note trouvée.</p>';
        }

        function deleteNote(noteId) {
            notes = notes.filter(n => n.id !== noteId);
            renderNotes();
            showToast('Note supprimée.', 'success');
        }

        updateCategoryOptions();
        renderGoals();
        updateStats();
    </script>
</body>
</html>